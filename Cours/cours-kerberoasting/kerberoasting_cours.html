<img src="kerberos_logo.png">
<h1><b>Kerberoasting</b></h1>
<br><br>
<p>
Le Kerberoasting est une attaque en environnement Active Directory basé sur la demande de Ticket de service et les attributs SPN.

Pour comprendre et effectuer cette attaque, il est primordial d’être familier avec la notion d’authentification Kerberos et les SPN.
<br><br>
</p> 

<h2 class="mb-3"><b>Rappel sur l'authentification Kerberos</b></h2>
<br>
<p>
    Dans un environnement Active Directory, par exemple dans le contexte d’un réseau d’entreprise, contrôleur de domaine Kerberos est une solution commune de gestion des acces et des identité
</p>
<br>
<p>
    Afin d’accéder à un service, Le client doit premièrement s’authentifier auprès du contôlleur de domaine Kerberos (KDC). Apres avoir vérifier son identité, le KDC fournira alors au client un Ticket Granting Ticket (TGT) et une clé de session chiffré avec le mot de passe du client.
<br><br>
Ce TGT, chiffré avec la clé du KDC donc inaccessible, contient divers informations:
<li>Le nom de l’utilisateur</li>
<li>Une clé de session chiffré avec la clé du client</li>
<li>Un PAC contenant des informations et les droits du client, chiffré avec la clé du KDC</li>
</p>
<br><br>
<p>
    Pour accéder a un service, le client va faire une requete de Ticket Granting Service (TGS) auprès du KDC. 

    Le client envoie donc au KDC :
<li>Son TGT précédemment généré</li>
<li>Le service auquel il souhaite se connecter</li>
<li>Un authentificator contenant les informations du client, chiffré avec la clé de session précédemment généré</li>
</p>
<br>
<p>
    Le KDC pourra donc verifier de son coté l’identité du client, et lui retourner un paquet chiffré avec la clé de session contenant une nouvelle clé de session et le TGS chiffré avec la clé du service contenant:
<li>La désignation du service souhaité</li>
<li>Le PAC </li>

<br>

    L’utilisateur est donc finalement autorisé à accéder au service
</p>
<br><br>
<p>
<img src="Kerberoasting.png">
</p>
<br><br>
<h2 class="mb-3"><b>Les SPN (Service Principal Name) </b></h2>
<p>
    Dans un environnement Active Directory, les membres de celui-ci peuvent acceder à des services. Ceux-ci peuvent être des fonctionnalités, logiciels, un share réseaux, un service DNS ou d’impression… 
<br>
    Le SPN réprésente ce service, il contient la machine hébergeant le service et le nom de celui-ci : 
    classe_du_service/hostname
    <br>
    Il peut aussi être de la forme:
    classe_du_service/hostname.domain_name
    <br>
    Par Exemple, le SPN d’un service web tournant sur une machine nommé WEB-SERVER-01 sera présenté de la maniere suivante :
    www/WEB-SERVER-01
</p>
<br><br>

<h2 class="mb-3"><b>Le Principe de l'attaque</b></h2>
<p>
    Le kerberoasting est une attaque permettant de compromettre de nouveaux compte dans un Active Directory, dans une optique de mouvement latéral et délévation de privileges. 

Elle permet d’acceder a des machines hebergeant des services grâce à une faille du protocole Kerberos. Elle repose sur la clé du service avec laquelle le KRB_TGS_REP est chiffré.
</p>
<br>
<img src="Cours/cours-kerberoasting/KRB_TGS_REP.png">
<br>
<p>
    En possédant un compte valide sur l’AD (pouvant donc avoir un TGT), on peut effectuer des demandes de TGS à n’importe quel service, par son SPN. En effet, le Domain Controller sous Kerberos ne vérifie pas les droits de l’utilisateurs demandant le ticket, il s’occupe seulement de fournir les informations de sécurité (PAC), c’est le compte de service qui s’occupe de vérifier les droits du demandeur. 
    <br>
Il est donc possible de lister les SPN de l’AD et d’effectuer une demande de TGS pour chacun de ces service. 

La plupart des ces comptes possedent cependant des mot de passe complexe et changés à intervalle régulier, il faut donc viser des comptes dont les mots de passes sont géré par des humains.
<br>
Il est possible de retrouver ces comptes en appliquant un filtre LDAP pour filtrer les comptes de types user qui possedent un SPN.

Il suffit donc d’effectuer la requête de TGS pour ce service et de brutforce le mot de passe en offline afin de le récuperer.
</p>
